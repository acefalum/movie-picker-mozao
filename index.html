<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteador de Filmes</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #1a1a1a; color: #fff; margin: 0; padding: 20px; text-align: center; background-image: url('background.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; }
        h1 { color: #e50914; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
        .container { display: block; max-width: 1200px; margin: auto; }
        .movie-card { position: relative; background-color: rgba(46, 46, 46, 0.8); backdrop-filter: blur(5px); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); width: 200px; text-align: left; transition: transform 0.3s, box-shadow 0.3s; border: 1px solid #444; }
        .movie-card:hover { transform: translateY(-8px); box-shadow: 0 0 20px rgba(229, 9, 20, 0.7); }
        .movie-card img { width: 100%; height: 300px; object-fit: cover; }
        .movie-info { padding: 15px; }
        .movie-info h3 { margin: 0 0 5px; font-size: 1.1em; }
        .movie-info p { margin: 0 0 5px; font-size: 0.9em; line-height: 1.3; }
        button { background-color: #e50914; color: #fff; border: none; padding: 12px 24px; font-size: 1em; cursor: pointer; border-radius: 5px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); transition: all 0.3s; }
        button:hover:not(:disabled) { background-color: #b2070c; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3); }
        button:disabled { background-color: #666; cursor: not-allowed; box-shadow: none; transform: none; }
        #sortear-section button { background-color: #0d83e2; padding: 20px 40px; font-size: 1.5em; border-radius: 8px; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
        .modal-content { background-color: #2e2e2e; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; position: relative; box-shadow: 0 8px 16px rgba(0,0,0,0.5); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content input[type="text"], .modal-content textarea { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #555; border-radius: 4px; background-color: #3e3e3e; color: #fff; }
        #result-container { display: none; flex-direction: column; align-items: center; margin-top: 40px; animation: fadeIn 1s; }
        #result-container img { width: 250px; height: 375px; object-fit: cover; border-radius: 8px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tabs-container { display: flex; justify-content: center; border-bottom: 2px solid #444; margin-bottom: 30px; }
        .tab-button { background-color: transparent; border: none; color: #aaa; padding: 15px 30px; font-size: 1.2em; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 3px solid transparent; margin: 0; }
        .tab-button:hover { color: #fff; background-color: transparent; }
        .tab-button.active { color: #e50914; border-bottom: 3px solid #e50914; }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        .movie-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
        .watched-movie-ratings { font-size: 0.8em; margin-top: 10px; padding-top: 5px; border-top: 1px solid #555; }
        .watched-movie-ratings p { font-size: 1em; }
        .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.3s ease; z-index: 10; }
        .movie-card:hover .card-actions { opacity: 1; }
        .card-action-btn { background-color: rgba(0, 0, 0, 0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 0; line-height: 1; }
        .card-action-btn:hover { background-color: #e50914; transform: scale(1.1); }
        .rating-tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .rating-tab { padding: 10px 20px; cursor: pointer; border-radius: 5px 5px 0 0; background-color: #3e3e3e; }
        .rating-tab.active { background-color: #e50914; }
        .rating-content { display: none; padding: 15px 0; }
        .rating-content.active { display: block; }
        .rating-movie-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #444; }
        .stars { font-size: 1.5em; cursor: pointer; }
        .stars .star { color: #888; transition: color 0.2s; }
        .stars .star.filled { color: gold; }
        .roulette-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; overflow: hidden; }
        #roulette-track { display: flex; position: absolute; left: 50%; transition: transform 7s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .roulette-item { width: 180px; height: 270px; margin: 0 10px; flex-shrink: 0; }
        .roulette-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .roulette-marker { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 190px; height: 280px; border: 4px solid #e50914; border-radius: 10px; z-index: 10; box-shadow: 0 0 20px #e50914; }
        #search-results-list { margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .search-result-item { display: flex; align-items: center; background-color: #3e3e3e; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .search-result-item img { width: 50px; height: 75px; object-fit: cover; border-radius: 3px; margin-right: 15px; }
        .search-result-info { flex-grow: 1; text-align: left; }
        .search-result-info h5 { margin: 0 0 5px; }
        .search-result-info p { margin: 0; font-size: 0.8em; color: #ccc; }

        /* --- NOVO CSS ADICIONADO --- */
        .spectator-mode #show-add-modal-btn,
        .spectator-mode #show-rating-modal-btn,
        .spectator-mode .card-actions,
        .spectator-mode #mark-as-watched-btn {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sorteador de Filmes</h1>
        <div style="margin-bottom: 20px;">
            <button id="show-add-modal-btn">Gerenciar Lista</button>
            <button id="show-rating-modal-btn">Dar Notas</button>
        </div>
        <div class="tabs-container">
            <button class="tab-button active" id="tab-to-watch">A Assistir</button>
            <button class="tab-button" id="tab-watched">Assistidos</button>
        </div>
        <div id="to-watch-content" class="tab-content active">
            <div id="sortear-section">
                <button id="spin-button" disabled>Sortear filme</button>
            </div>
            <div id="to-watch-list" class="movie-list"></div>
        </div>
        <div id="watched-content" class="tab-content">
            <div id="watched-list" class="movie-list"></div>
        </div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-add-modal">&times;</span>
            <h2>Gerenciar Lista</h2>
            <h4>Adicionar em Massa</h4>
            <p>Cole uma lista de filmes separados por v√≠rgula.</p>
            <textarea id="bulk-add-input" rows="4" placeholder="Ex: Interestelar, O Poderoso Chef√£o, A Origem..."></textarea>
            <div style="text-align: left; margin: 10px 0;">
                <input type="checkbox" id="bulk-add-watched-checkbox">
                <label for="bulk-add-watched-checkbox">Adicionar diretamente como 'Assistidos'</label>
            </div>
            <button id="bulk-add-btn">Adicionar em Massa</button>
            <hr style="margin: 20px 0;">
            <h4>Busca Avan√ßada</h4>
            <div style="display: flex;">
                <input type="text" id="add-input" placeholder="Digite o nome do filme..." style="flex-grow: 1; margin-bottom: 0;">
                <button id="search-btn" style="margin-left: 10px;">Buscar</button>
            </div>
            <div id="search-results-list"></div>
            <hr style="margin: 20px 0;">
            <h4>Backup e Restaura√ß√£o</h4>
            <p>Salve sua lista em um arquivo ou carregue um backup.</p>
            <div style="display: flex; gap: 10px;">
                <button id="export-btn" style="flex-grow: 1; background-color: #28a745;">Exportar Dados</button>
                <button id="import-btn" style="flex-grow: 1; background-color: #17a2b8;">Importar Dados</button>
            </div>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
        </div>
    </div>

    <div id="rating-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-rating-modal">&times;</span>
            <h2>Dar Notas aos Filmes Assistidos</h2>
            <div class="rating-tabs">
                <div class="rating-tab active" data-user="Mana">Man√°</div>
                <div class="rating-tab" data-user="Mandinha">Mandinha</div>
            </div>
            <div id="mana-ratings-content" class="rating-content active"></div>
            <div id="mandinha-ratings-content" class="rating-content"></div>
        </div>
    </div>

    <div id="result-container">
        <img id="result-poster" src="" alt="Poster do Filme">
        <div class="result-info">
            <h2 id="result-title"></h2>
            <p id="result-director"></p>
            <p id="result-runtime"></p>
            <p id="result-genre"></p>
            <p id="result-sinopse"></p>
        </div>
        <button id="mark-as-watched-btn">Marcar como Assistido</button>
        <button id="spin-again-button">Sortear novamente</button>
    </div>

    <div id="roulette-container" class="modal">
        <div class="roulette-wrapper">
            <div class="roulette-marker"></div>
            <div id="roulette-track"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tmdbApiKey = '6e14296dafeef1e81523bfa6615e840c';

            // --- NOVO: ESTADO DA SESS√ÉO ---
            let isEditor = false;
            let sessionPassword = null;

            // --- ELEMENTOS DO DOM ---
            const body = document.body;
            const container = document.querySelector('.container');
            const showAddModalBtn = document.getElementById('show-add-modal-btn');
            const showRatingModalBtn = document.getElementById('show-rating-modal-btn');
            const addModal = document.getElementById('add-modal');
            const ratingModal = document.getElementById('rating-modal');
            const closeAddModal = document.getElementById('close-add-modal');
            const closeRatingModal = document.getElementById('close-rating-modal');
            const addInput = document.getElementById('add-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResultsList = document.getElementById('search-results-list');
            const bulkAddInput = document.getElementById('bulk-add-input');
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const bulkAddWatchedCheckbox = document.getElementById('bulk-add-watched-checkbox');
            const tabToWatch = document.getElementById('tab-to-watch');
            const tabWatched = document.getElementById('tab-watched');
            const toWatchContent = document.getElementById('to-watch-content');
            const watchedContent = document.getElementById('watched-content');
            const toWatchListDiv = document.getElementById('to-watch-list');
            const watchedListDiv = document.getElementById('watched-list');
            const spinButton = document.getElementById('spin-button');
            const spinAgainButton = document.getElementById('spin-again-button');
            const markAsWatchedBtn = document.getElementById('mark-as-watched-btn');
            const resultContainer = document.getElementById('result-container');
            const resultPoster = document.getElementById('result-poster');
            const resultTitle = document.getElementById('result-title');
            const resultDirector = document.getElementById('result-director');
            const resultRuntime = document.getElementById('result-runtime');
            const resultGenre = document.getElementById('result-genre');
            const resultSinopse = document.getElementById('result-sinopse');
            const ratingTabs = document.querySelectorAll('.rating-tab');
            const rouletteContainer = document.getElementById('roulette-container');
            const rouletteTrack = document.getElementById('roulette-track');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            let movies = [];
            let ratings = { "Man√°": {}, "Mandinha": {} };
            let currentSelectedMovieId = null;

            // --- NOVO: L√ìGICA DE SESS√ÉO ---
            async function initSession() {
                const password = prompt("Para editar a lista, por favor, insira a senha.\nPara apenas visualizar, clique em 'Cancelar' ou 'OK' com o campo vazio.");
                if (!password) {
                    enterSpectatorMode();
                    return;
                }
                try {
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'verify_password', password: password })
                    });
                    if (response.ok) {
                        enterEditorMode(password);
                    } else {
                        alert('Senha incorreta. Entrando em modo de visualiza√ß√£o.');
                        enterSpectatorMode();
                    }
                } catch (error) {
                    alert('Erro de conex√£o. Entrando em modo de visualiza√ß√£o.');
                    enterSpectatorMode();
                }
            }

            function enterEditorMode(password) {
                isEditor = true;
                sessionPassword = password;
                body.classList.remove('spectator-mode');
                loadData();
            }

            function enterSpectatorMode() {
                isEditor = false;
                sessionPassword = null;
                body.classList.add('spectator-mode');
                loadData();
            }

            // --- FUN√á√ÉO saveData MODIFICADA ---
            async function saveData() {
                if (!isEditor) {
                    alert("Voc√™ est√° em modo de visualiza√ß√£o e n√£o pode fazer altera√ß√µes.");
                    return;
                }
                try {
                    const dataToSave = { movies: movies, ratings: ratings };
                    const response = await fetch('/api/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: sessionPassword, // Usa a senha guardada na sess√£o
                            data: dataToSave
                        })
                    });
                    if (!response.ok) {
                        alert('Ocorreu um erro ao salvar. Sua sess√£o pode ter expirado. Por favor, recarregue a p√°gina.');
                        enterSpectatorMode();
                    }
                } catch (error) {
                    console.error("Erro ao salvar dados:", error);
                }
            }
            
            // --- FUN√á√ÉO createMovieCard MODIFICADA ---
           // SUBSTITUA A SUA FUN√á√ÉO createMovieCard POR ESTA:
        async function createMovieCard(movie) {
            const details = await fetchMovieDetails(movie.tmdbId);
            const card = document.createElement('div');
            card.classList.add('movie-card');
        
            let actionsHTML = '';
            if (isEditor) {
                actionsHTML = movie.status === 'to-watch'
                    ? `<div class="card-actions"><button class="card-action-btn mark-watched-btn" title="Marcar como Assistido">‚úì</button><button class="card-action-btn remove-btn" title="Remover Filme">üóëÔ∏è</button></div>`
                    : `<div class="card-actions"><button class="card-action-btn remove-btn" title="Remover Filme">üóëÔ∏è</button></div>`;
            }
        
            let ratingsHTML = '';
            if (movie.status === 'watched') {
                const r1 = ratings['Man√°']?.[movie.tmdbId] || 0;
                const r2 = ratings['Mandinha']?.[movie.tmdbId] || 0;
                ratingsHTML = `<div class="watched-movie-ratings"><p><strong>Notas:</strong> Man√°: ${'‚òÖ'.repeat(r1)}${'‚òÜ'.repeat(5-r1)} | Mandinha: ${'‚òÖ'.repeat(r2)}${'‚òÜ'.repeat(5-r2)}</p></div>`;
            }
        
            // --- A CORRE√á√ÉO EST√Å NA LINHA ABAIXO ---
            // Trocamos 'd.' por 'details.' e '${r}' por '${ratingsHTML}'
            card.innerHTML = `
                ${actionsHTML}
                <img src="${details.poster || 'https://via.placeholder.com/200x300.png'}" alt="${details.title}">
                <div class="movie-info">
                    <h3>${details.title} (${details.releaseYear})</h3>
                    <p><strong>Diretor:</strong> ${details.director}</p>
                    <p><strong>Dura√ß√£o:</strong> ${details.runtime}</p>
                    <p><strong>G√™nero:</strong> ${details.genre}</p>
                    ${ratingsHTML}
                </div>
            `;
        
            const markBtn = card.querySelector('.mark-watched-btn');
            if (markBtn) markBtn.addEventListener('click', e => { e.stopPropagation(); markMovieAsWatched(movie.tmdbId); });
        
            const removeBtn = card.querySelector('.remove-btn');
            if (removeBtn) removeBtn.addEventListener('click', e => { e.stopPropagation(); if (confirm(`Remover "${details.title}"?`)) removeMovie(movie.tmdbId); });
        
            return card;
        }
            
            // --- RESTANTE DAS FUN√á√ïES (sem altera√ß√µes profundas) ---
            async function loadData() { try { const r = await fetch('/api/data'); if (!r.ok) throw new Error('Erro de rede'); const d = await r.json(); movies = d.movies || []; ratings = d.ratings || { "Man√°": {}, "Mandinha": {} }; displayMovies(); updateSpinButton(); } catch (e) { console.error(e); alert("N√£o foi poss√≠vel carregar sua lista de filmes. Tente recarregar a p√°gina."); } }
            function updateSpinButton() { const twm = movies.filter(m => m.status === 'to-watch'); spinButton.disabled = twm.length === 0; }
            function showModal(modal) { modal.style.display = 'block'; }
            function hideModal(modal) { modal.style.display = 'none'; }
            async function fetchMovieDetails(tmdbId) { const url=`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${tmdbApiKey}&language=pt-BR&append_to_response=credits`; try{const r=await fetch(url);if(!r.ok)return{title:"Filme n√£o encontrado"};const d=await r.json();return{title:d.title||"?",releaseYear:d.release_date?d.release_date.substring(0,4):'N/A',poster:d.poster_path?`https://image.tmdb.org/t/p/w500${d.poster_path}`:null,sinopse:d.overview||'Indispon√≠vel',director:d.credits?.crew.find(c=>c.job==='Director')?.name||'N/A',runtime:d.runtime?`${d.runtime} min`:'N/A',genre:d.genres?.map(g=>g.name).join(', ')||'N/A'}}catch(e){console.error(e);return{title:"Erro"}} }
            async function displayMovies() { toWatchListDiv.innerHTML='<h3>Carregando...</h3>'; watchedListDiv.innerHTML=''; const twp=movies.filter(m=>m.status==='to-watch').map(createMovieCard); const wp=movies.filter(m=>m.status==='watched').map(createMovieCard); const twc=await Promise.all(twp); const wc=await Promise.all(wp); toWatchListDiv.innerHTML=''; twc.forEach(c=>toWatchListDiv.appendChild(c)); watchedListDiv.innerHTML=''; wc.forEach(c=>watchedListDiv.appendChild(c)); }
            function markMovieAsWatched(tmdbId) { const i=movies.findIndex(m=>m.tmdbId===tmdbId); if(i!==-1){movies[i].status='watched';saveData();displayMovies();updateSpinButton()} }
            function displayRatings() { const mc=document.getElementById('mana-ratings-content'); const mac=document.getElementById('mandinha-ratings-content'); mc.innerHTML=''; mac.innerHTML=''; const wm=movies.filter(m=>m.status==='watched'); if(wm.length===0){const msg='<p>Nenhum filme assistido para avaliar.</p>'; mc.innerHTML=msg; mac.innerHTML=msg; return} wm.forEach(m=>{mc.appendChild(createRatingItem(m,'Man√°'));mac.appendChild(createRatingItem(m,'Mandinha'))}) }
            function createRatingItem(movie,user) { const i=document.createElement('div'); i.className='rating-movie-item'; const cr=ratings[user]?.[movie.tmdbId]||0; const sh=Array.from({length:5},(_,idx)=>`<span class="star ${idx<cr?'filled':''}" data-value="${idx+1}">‚òÖ</span>`).join(''); i.innerHTML=`<span>${movie.title} (${movie.releaseYear})</span><div class="stars">${sh}</div>`; i.querySelectorAll('.star').forEach(s=>{s.addEventListener('click',()=>{if(!ratings[user])ratings[user]={};ratings[user][movie.tmdbId]=parseInt(s.dataset.value);saveData()})}); return i; }
            function switchTab(tab) { tabToWatch.classList.remove('active'); tabWatched.classList.remove('active'); toWatchContent.classList.remove('active'); watchedContent.classList.remove('active'); if(tab==='watched'){tabWatched.classList.add('active');watchedContent.classList.add('active')}else{tabToWatch.classList.add('active');toWatchContent.classList.add('active')} }
            async function handleSearch() { const q=addInput.value.trim(); if(!q)return; searchResultsList.innerHTML='<p>Buscando...</p>'; const u=`https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(q)}&language=pt-BR`; const r=await fetch(u); const d=await r.json(); searchResultsList.innerHTML=''; if(d.results&&d.results.length>0){d.results.forEach(m=>{const i=document.createElement('div'); i.className='search-result-item'; const y=m.release_date?m.release_date.substring(0,4):'N/A'; i.innerHTML=`<img src="${m.poster_path?`https://image.tmdb.org/t/p/w200${m.poster_path}`:'https://via.placeholder.com/50x75.png'}" alt="P"><div class="search-result-info"><h5>${m.title}</h5><p>${y}</p></div><button class="add-this-movie-btn" data-tmdb-id="${m.id}" data-title="${m.title}" data-year="${y}">Adicionar</button>`; searchResultsList.appendChild(i)})}else{searchResultsList.innerHTML='<p>Nenhum resultado.</p>'} }
            function addMovieFromSearch(id,t,y) { if(!movies.some(m=>m.tmdbId===id)){movies.push({tmdbId:id,title:t,releaseYear:y,status:'to-watch'});saveData()}else{alert(`"${t}" j√° est√° na lista.`)} }
            async function handleBulkAdd() { const titles = bulkAddInput.value.split(',').map(t => t.trim()).filter(Boolean); if (titles.length === 0) return; const statusParaAdicionar = bulkAddWatchedCheckbox.checked ? 'watched' : 'to-watch'; let addedCount = 0; let existingCount = 0; bulkAddBtn.disabled = true; bulkAddBtn.textContent = 'Adicionando...'; for (const title of titles) { const url = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(title)}&language=pt-BR`; const response = await fetch(url); const data = await response.json(); if (data.results && data.results.length > 0) { const movie = data.results[0]; if (!movies.some(m => m.tmdbId === movie.id)) { movies.push({ tmdbId: movie.id, title: movie.title, releaseYear: movie.release_date ? movie.release_date.substring(0, 4) : 'N/A', status: statusParaAdicionar }); addedCount++; } else { existingCount++; } } } let alertMessage = `${addedCount} de ${titles.length} filmes foram adicionados com sucesso!`; if (existingCount > 0) { alertMessage += `\n${existingCount} filmes j√° estavam na lista.`; } alert(alertMessage); bulkAddInput.value = ''; bulkAddWatchedCheckbox.checked = false; bulkAddBtn.disabled = false; bulkAddBtn.textContent = 'Adicionar em Massa'; saveData(); }
            function removeMovie(id) { movies=movies.filter(m=>m.tmdbId!==id); if(ratings["Man√°"])delete ratings["Man√°"][id]; if(ratings["Mandinha"])delete ratings["Mandinha"][id]; saveData(); }
            async function spinMovie() { const twm=movies.filter(m=>m.status==='to-watch'); if(twm.length===0)return; container.style.display='none'; if(twm.length<2){currentSelectedMovieId=twm[0].tmdbId;const d=await fetchMovieDetails(currentSelectedMovieId);displayFinalResult(d);return} showModal(rouletteContainer); let ri=[]; for(let i=0;i<5;i++){ri.push(...twm.sort(()=>Math.random()-0.5))} const wi=Math.floor(ri.length/2)+Math.floor(Math.random()*5)-2; const wm=ri[wi]; currentSelectedMovieId=wm.tmdbId; const pp=ri.map(async m=>{const d=await fetchMovieDetails(m.tmdbId);return`<div class="roulette-item"><img src="${d.poster||'https://via.placeholder.com/200x300.png'}" alt="${d.title}"></div>`}); rouletteTrack.innerHTML=(await Promise.all(pp)).join(''); const iw=200; const ro=Math.random()*(iw-40)-((iw-40)/2); const fp=-(wi*iw-iw/2+ro); setTimeout(()=>{rouletteTrack.style.transform=`translateX(${fp}px)`},100); setTimeout(async()=>{const wd=await fetchMovieDetails(wm.tmdbId);hideModal(rouletteContainer);displayFinalResult(wd)},7500); }
            function displayFinalResult(d) { resultPoster.src=d.poster||'https://via.placeholder.com/250x375.png'; resultTitle.textContent=`${d.title} (${d.releaseYear})`; resultDirector.textContent=`Diretor: ${d.director}`; resultRuntime.textContent=`Dura√ß√£o: ${d.runtime}`; resultGenre.textContent=`G√™nero: ${d.genre}`; resultSinopse.textContent=`Sinopse: ${d.sinopse}`; resultContainer.style.display='flex'; }
            function handleMarkAsWatched() { if(!currentSelectedMovieId)return; const i=movies.findIndex(m=>m.tmdbId===currentSelectedMovieId); if(i!==-1){movies[i].status='watched';saveData()} }
            function handleExport() { const dataToExport = { movies: movies, ratings: ratings }; const dataStr = JSON.stringify(dataToExport, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_filmes_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('Backup exportado com sucesso!'); }
            function handleImport(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (importedData && importedData.movies && importedData.ratings) { movies = importedData.movies; ratings = importedData.ratings; saveData(); alert('Dados importados com sucesso!'); hideModal(addModal); } else { alert('Erro: O arquivo de backup parece ser inv√°lido.'); } } catch (error) { console.error("Erro ao importar:", error); alert('Erro: O arquivo n√£o √© um JSON v√°lido.'); } finally { importFileInput.value = ''; } }; reader.readAsText(file); }

            showAddModalBtn.addEventListener('click', () => showModal(addModal));
            closeAddModal.addEventListener('click', () => { hideModal(addModal); searchResultsList.innerHTML = ''; });
            searchBtn.addEventListener('click', handleSearch);
            addInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
            searchResultsList.addEventListener('click', (e) => { if (e.target.classList.contains('add-this-movie-btn')) { const btn = e.target; addMovieFromSearch(parseInt(btn.dataset.tmdbId), btn.dataset.title, btn.dataset.year); } });
            bulkAddBtn.addEventListener('click', handleBulkAdd);
            spinButton.addEventListener('click', spinMovie);
            markAsWatchedBtn.addEventListener('click', () => { handleMarkAsWatched(); resultContainer.style.display = 'none'; container.style.display = 'block'; switchTab('watched'); });
            spinAgainButton.addEventListener('click', () => { resultContainer.style.display = 'none'; container.style.display = 'block'; spinMovie(); });
            tabToWatch.addEventListener('click', () => switchTab('to-watch'));
            tabWatched.addEventListener('click', () => switchTab('watched'));
            showRatingModalBtn.addEventListener('click', () => { displayRatings(); showModal(ratingModal); });
            closeRatingModal.addEventListener('click', () => { hideModal(ratingModal); displayMovies(); });
            ratingTabs.forEach(tab => { tab.addEventListener('click', () => { ratingTabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.rating-content').forEach(c => c.classList.remove('active')); const user=tab.dataset.user.toLowerCase(); document.getElementById(`${user}-ratings-content`).classList.add('active'); }); });
            exportBtn.addEventListener('click', handleExport);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', handleImport);
            
            initSession();
        });
    </script>
</body>
</html>

